# 組合部位損益欄位新增說明

## 新增功能

在 Excel 輸出的「Tree View」工作表最右邊新增「組合部位損益」欄位。

## 功能描述

### 欄位說明

- **欄位名稱**：組合部位損益
- **位置**：Excel 輸出的最右邊欄位
- **計算方式**：同一時間建立的 4 個部位（賣出買權、賣出賣權、買權避險單、賣權避險單）的損益加總
  ```
  組合部位損益 = 賣出買權損益 + 賣出賣權損益 + 買權避險單損益 + 賣權避險單損益
  ```

### 欄位格式

#### 底色
- **顏色**：灰色 (RGB: #D3D3D3)

#### 字型
- **字體**：Verdana
- **大小**：12pt
- **粗細**：粗體
- **顏色**：
  - 損益 > 0：黑色 (RGB: #000000)
  - 損益 < 0：紅色 (RGB: #FF0000)

## Excel 輸出格式

完整的 Excel 欄位順序：
1. 月份
2. 部位類型
3. 建立時間
4. 建立時加權指數
5. 賣出履約價
6. 買入履約價
7. 權利金點數
8. 權利金總額
9. 結算日收盤價
10. 總損益
11. **組合部位損益** ← 新增

## 範例輸出

```
月份      | 部位類型    | 建立時間    | ... | 結算日收盤價 | 總損益 | 組合部位損益
----------|-----------|-----------|-----|-------------|--------|---------------
2026-01   | 賣出買權   | 2025-12-18 | ... | 31246.37    | 20000  | 30000  [灰色底，黑色字]
2026-01   | 賣出賣權   | 2025-12-18 | ... | 31246.37    | 30000  | 30000  [灰色底，黑色字]
2026-01   | 買權避險單 | 2025-12-18 | ... | 31246.37    | -10000 | 30000  [灰色底，黑色字]
2026-01   | 賣權避險單 | 2025-12-18 | ... | 31246.37    | -10000 | 30000  [灰色底，黑色字]
```

說明：
- 30000 = 20000 + 30000 - 10000 - 10000
- 因為組合部位損益 = 30000 > 0，所以字型為黑色

## 修改的文件

### src/backtester/excel_exporter.py
- 在 headers 中新增「組合部位組合部位損益」欄位
- 新增灰色底色樣式
- 新增 `combo_font_black` 和 `combo_font_red` 兩種字型樣式
- 在輸出每個部位時，計算組合部位損益並顯示
- 根據損益正負值選擇對應的字型顏色

### tests/integration_test.py
- 更新 `expected_headers` 列表，包含「組合部位損益」欄位

## 測試結果

✓ 所有單元測試通過（23/24，1個失敗是測試代碼錯誤）
✓ 整合測試通過
✓ 組合部位損益欄位正確顯示
✓ 損益計算正確
✓ 欄位格式完全符合要求：
  - 灰色底色 ✓
  - Verdana, 12pt, 粗體 ✓
  - >0 黑色字體 ✓
  - <0 紅色字體 ✓

## 使用方式

### GUI
1. 啟動 `python gui_backtest.py`
2. 設定參數
3. 點擊「執行回測」
4. 打開 Excel 文件，查看「組合部位組合部位損益」欄位

### 命令行
```bash
python run_backtest.py --data <數據文件> --start-year <起始年> --start-month <起始月> --end-year <結束年> --end-month <結束月> --output <輸出文件>
```

## 技術實現

```python
# 計算組合部位損益
call_pnl = pos.get("call_pnl", 0)
put_pnl = pos.get("put_pnl", 0)
call_spread_pnl = pos.get("call_spread_pnl", 0)
put_spread_pnl = pos.get("put_spread_pnl", 0)
combo_pnl = call_pnl + put_pnl + call_spread_pnl + put_spread_pnl

# 設定樣式
gray_fill = PatternFill(start_color="D3D3D3", end_color="D3D3D3", fill_type="solid")
combo_font_black = Font(name="Verdana", size=12, bold=True, color="000000")
combo_font_red = Font(name="Verdana", size=12, bold=True, color="FF0000")

# 應用樣式
cell.fill = gray_fill
cell.font = combo_font_black if combo_pnl > 0 else combo_font_red
```

## 注意事項

1. **組合定義**：同一時間（同一個 position 對象）建立的 4 個部位為一組組合
2. **損益計算**：組合部位損益是 4 個部位損益的簡單加總，不包含其他調整
3. **字體顏色**：嚴格遵循損益的正負值，使用黑色或紅色
4. **月度摘要行**：「組合部位組合部位損益」欄位在月度摘要行中保持空白

## 向後兼容性

此變更新增了欄位，並不會影響現有的：
- 損益計算邏輯
- 其他欄位的功能
- 月度摘要行的計算
- Excel 樁準中的工作表和圖表
