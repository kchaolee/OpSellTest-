# 交易策略說明

## 交易區間

本系統採用每月為周期的選擇權賣方策略，每個月的**交易區間**定義如下：

### 區間計算
- **起始日期**：上一個月的第三個週四
- **結算日期**：當月的第三個週三

### 範例
以 2026年1月為例：
- 起始日期：2025年12月的第三個週四（2025/12/18）
- 結算日期：2026年1月的第三個週三（2026/01/21）
- 交易區間：2025/12/18 ~ 2026/01/21

## 策略內容

### 1. 賣出跨式部位（Naked Straddle）
在指定的基準指數上建立賣出買權和賣出賣權部位：
- **賣出買權（Call）**：履約價 = 基準指數 × (1 + n%)
- **賣出賣權（Put）**：履約價 = 基準指數 × (1 - n%)

預期收取的權利金：
- 買權權利金 = 400點 × 契約乘數（50）= 20,000點
- 賣權權利金 = 600點 × 契約乘數（50）= 30,000點
- **總權利金收入** = 50,000點

### 2. 價差部位對沖（Spread Hedge）
為了控制風險，建立價差部位進行對沖：

**買權價差**：
- 買入買權：履約價 = 賣出買權履約價 + 400點
- 賣出買權：履約價 = 買入買權履約價 + n% × 基準指數
- 成本 = 200點 × 契約乘數（50）= 10,000點

**賣權價差**：
- 買入賣權：履約價 = 賣出賣權履約價 - 600點
- 賣出賣權：履約價 = 買入賣權履約價 - n% × 基準指數
- 成本 = 200點 × 契約乘數（50）= 10,000點

### 3. 部位觸發條件
在交易區間內，滿足以下條件之一時建立新部位：
- 計算觸發距離：基準指數 × n% × 0.5
- 若計算出的觸發距離 < 500點，則使用 500點作為觸發距離
- 當指數漲跌幅達到觸發距離時建立新部位
- 區間第一天（強制建立部位）
- 達到每月最大部位數限制（預設 5個）

**觸發距離計算範例**：
- 基準指數 = 10000, n = 3：觸發距離 = 10000 × 0.03 × 0.5 = 150點 → **使用 500點**
- 基準指數 = 20000, n = 3：觸發距離 = 20000 × 0.03 × 0.5 = 300點 → **使用 500點**
- 基準指數 = 35000, n = 3：觸發距離 = 35000 × 0.03 × 0.5 = 525點 → **使用 525點**

### 4. 損益計算
在結算日（第三個週三），以當日收盤價計算各部位損益：

**賣出買權損益**：
- 權利金 - 內在價值 = 400 × 50 - max(0, 收盤價 - 履約價) × 50

**賣出賣權損益**：
- 權利金 - 內在價值 = 600 × 50 - max(0, 履約價 - 收盤價) × 50

**買權價差損益**：
- 若 收盤價 < 買入履約價：-200 × 50
- 若 買入履約價 ≤ 收盤價 < 賣出履約價：(收盤價 - 買入履約價) × 50 - 200 × 50
- 若 收盤價 ≥ 賣出履約價：(賣出履約價 - 買入履約價) × 50 - 200 × 50

**賣權價差損益**：
- 若 收盤價 < 賣出履約價：(買入履約價 - 賣出履約價) × 50 - 200 × 50
- 若 賣出履約價 ≤ 收盤價 < 買入履約價：(買入履約價 - 收盤價) × 50 - 200 × 50
- 若 收盤價 ≥ 買入履約價：-200 × 50

**總損益**：
- 權利金收入 - 避險成本 + 各部位損益

## 回測方式

### 按年回測
執行整年的回測（12個月）：
```bash
python run_backtest.py --data <數據文件> --year <年份>
```

### 按月範圍回測
執行指定月份範圍的回測（可跨年）：
```bash
python run_backtest.py --data <數據文件> --start-year <起始年> --start-month <起始月> --end-year <結束年> --end-month <結束月>
```

### 範例
回測 2025年8月 到 2026年1月：
```bash
python run_backtest.py --data "skills/opsell/assets/TSEA_加權指_日線.csv" --start-year 2025 --start-month 8 --end-year 2026 --end-month 1 --output "backtest_2025_08_2026_01.xlsx"
```

這將讀取從 2025年7月（12月第三個週四，即 2025/07/17）到 2026年1月（第三個週三，即 2026/01/21）的數據進行回測。
