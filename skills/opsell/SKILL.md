---
name: 台股指數選擇權雙賣策略回測
description: 回測台股指數選擇權雙賣策略，以歷史每日資料為基礎，回推每月的損益情況，並分析策略的績效表現。
---

# 台股指數選擇權雙賣策略回測

## 策略概述
取得測試月份的上個月第三個星期四為測試月份的第一個交易日，賣出一組台股指數選擇權的買權和賣權，並持有至測試月份的結算日(當月的的第三個星期三）。初始賣出的選擇權履約價分別為當月指數價格的±n%。每月結算時，計算損益並分析策略績效。

## 初始(第一組)部位建立
1. 取得測試月份的上個月第三個星期四為測試月份的第一個交易日，以當天的台股指數開盤價格，設定為初始建立部位指數價格。
2. 建立賣出買權部位
   - 計算賣出買權履約價 sellCallIdx：n 為設定的百分比，例如3%，賣出買權履約價(sellCallIdx) = 建立部位指數價格 + 建立部位指數價格*n%，賣出所獲取的權利金為 GetSellCallPoint
   比如：建立部位指數價格為 30000 點，賣出買權履約價(sellCallIdx) = 30000 + 30000*3% = 30900 點，獲取權利金GetSellCallPoint為 400 點。獲取權利金GetSellCallPoint可以於回測程序中設定為參數值。
3. 建立賣出賣權部位
   -  計算賣出賣權履約價 sellPutIdx ：n 為設定的百分比，例如3%，賣出賣權履約價(sellPutIdx) = 建立部位指數價格 - 建立部位指數價格*n% ，賣出所獲取的權利金為 GetSellPutPoint
   比如：建立部位指數價格為 30000 點，賣出賣權履約價(sellPutIdx) = 30000 - 30000*3% = 29100 點，獲取權利金GetSellPutPoint為 600 點。獲取權利金GetSellPutPoint可以於回測程序中設定為參數值。

4. 建立買權組合單的避險部位：同時買入一張履約價=(sellCallIdx + GetSellCallPoint) 的買權和賣出一張履約價=(sellCallIdx + GetSellCallPoint + 建立部位指數價格*n% )的買權，假設買入成本為CostBuyCallPoint點，買入成本可以於回測程序中設定為固定值。 


5. 建立賣權組合單的避險部位：同時買入一張履約價=(sellPutIdx-GetSellPutPoint) 的賣權和賣出一張履約價=(sellPutIdx-GetSellPutPoint-建立部位指數價格*n%)的賣權，假設買入成本為 CostBuyPutPoint點，買入成本可以於回測程序中設定為固定值。 


## 加權指數歷史資料
使用 assets\TSEA_加權指_日線.csv 讀取台股指數的歷史每日資料，包含開盤價、收盤價、最高價、最低價等資訊，以便於每月的部位建立和損益計算。

## 期指選擇權結算日
每月的第三個星期三為期指選擇權的結算日，次一日則為次月的第一個交易日。歷史結算日資訊可參考 assets\TSEA_加權指_日線.csv 中的日期欄位，如當月的第三個星期三結算日期無法在資料中找到，則以之後最接近的一日作為當月結算日。


## 持續建立部位
於每月的交易日區間，當加權指數的最高價或最低價突破上一個建立部位指數價格+-n/2%時，重複上述步驟建立新的部位，並持有至結算日。新部位建立後，以此新部位的建立指數作為下一個監控的基準指數，形成鏈式監控機制。
比如：上一個部位的建立指數價格為 30000 點，n為 3%，則當加權指數的最高價突破 30000 + 30000*3%/2 = 30900 點 或最低價突破 30000 - 30000*3%/2 = 29100 點 時，則建立新的部位，假設新部位建立時指數為 31000 點，則下一個監控區間的突破點為 31000±31000*3%/2。
需要能於推算的程序中設定每月建立部位的最大次數 MaxOrder，以避免過度交易。

## 每月損益計算 
於每月的結算日，計算所有持有部位的損益情況，並統計當月的總損益。每一部位損益計算方式如下：
- 賣出買權部位損益 = (結算日收盤價 - 賣出履約價sellCallIdx) * 50 * 1，當結算日收盤價 < 賣出履約價sellCallIdx 時，損益為 0。
- 賣出賣權部位損益 = (賣出履約價sellPutIdx - 結算日收盤價) * 50 * 1，當結算日收盤價 > 賣出履約價sellPutIdx 時，損益為 0。
- 買權組合單損益 =
    1. 當結算日收盤價 > 賣出履約時損益= （賣出履約價-買入履約價）* 50 * 1 - CostBuyCallPoint*50。
    2. 當買入履約價 < 結算日收盤價 < 賣出履約價時損益= （結算日收盤價-買入履約價）* 50 * 1 - CostBuyCallPoint*50。
    3. 當結算日收盤價 < 買入履約價時損益為 -CostBuyCallPoint*50。
- 賣權組合單損益 =
    1. 當結算日收盤價 < 賣出履約價時損益= （買入履約價-賣出履約價）* 50 * 1 - CostBuyPutPoint*50。
    2. 當賣出履約價 < 結算日收盤價 < 買入履約價時損益= （買入履約價-結算日收盤價）* 50 * 1 - CostBuyPutPoint*50。
    3. 當結算日收盤價 > 買入履約價時損益為 -CostBuyPutPoint*50。
-此部位的總損益 = GetSellCallPoint*50 + GetSellPutPoint*50 - CostBuyCallPoint*50 - CostBuyPutPoint*50 + 賣出買權部位損益 + 賣出賣權部位損益 + 買權避險組合單損益 + 賣權避險組合單損益


## 回測程序建立 
   以 Python 建立回測程序，設定回測的開始月份和結束月份，並依據上述策略規則進行每月的部位建立、損益計算和績效分析。回測程序需能夠處理歷史資料中的日期、價格等資訊，並能夠根據設定的參數進行靈活的策略調整。
   設定的參數包括：n（履約價距離百分比）、 GetSellCallPoint（賣出買權獲取權利金）、 GetSellPutPoint（賣出賣權獲取權利金）、CostBuyCallPoint（買入買權避險組合單成本）、CostBuyPutPoint（買入賣權避險組合單成本）、MaxOrder（每月建立部位的最大次數）等。

## 損益統計分析輸出
   以回測程序回測，將每月回測的每一筆組合部位建立的時間、履約價、結算價、總損益等資訊，建立 excel 頁面1 呈現。以樹狀型式顯式，父列表欄位內容：建立部位序號。點擊展開子列表，子列表欄位內容如下：
   | 月份 | 部位類型| 建立時間 | 賣出履約價 | 買入履約價 | 權利金點數 | 權利金總額 | 結算日收盤價 | 總損益 |

   資料範例1(賣出買權)：建立部位的時間為 2023-01-02，建立部位當時指數為30000，賣出買權履約價為 30000+30000*3% = 30900 點，獲取權利金GetSellCallPoint為 400 點（20000元），結算日收盤價為 31500 點，損益= 400*50-(31500-30900)*50 = -10000 元，則該筆資料記錄如下：
   | 2023-01 | 賣出買權 | 2023-01-02 | 30900 | - | 400 | 20000 | 31500 | -10000 |

   資料範例2(賣出賣權)：建立部位的時間為 2023-01-02，建立部位當時指數為30000，賣出賣權履約價為 30000-30000*3% = 29100 點，獲取權利金GetSellPutPoint為 600 點（30000元），結算日收盤價為 31500 點，損益= 600*50-0 = 30000 元，則該筆資料記錄如下：
   | 2023-01 | 賣出賣權 | 2023-01-02 | 29100 | - | 600 | 30000 | 31500 | 30000 |

   資料範例3(買權避險單)：建立部位的時間為 2023-01-02，建立部位指數為30000，賣出買權的履約價=30000+30000*3% = 30900 點，買權避險單的買入CALL履約價為（30900+400）=31300 點，賣出履約價=買入CALL履約價31400+30000*3%）=32300 點，買權避險單的付出權利金=200點（10000元），結算日收盤價為 31500 點，損益= (31500-31400)*50 - 10000 = -5000 元，則該筆資料記錄如下：
   | 2023-01 | 買權避險單 | 2023-01-02 | 31400 | 32300 | 200 | 10000 | 31500 | -5000 |

   資料範例4(賣權避險單)：建立部位的時間為 2023-01-02，建立部位指數為30000，賣出賣權的履約價=30000-30000*3% = 29100 點，賣權避險單的買入PUT履約價為（29100-600）=28500 點，賣出PUT履約價=買入PUT履約價28500-30000*3%）=27600 點，賣權避險單權的利金CostBuyPUTPoint=200點（10000元），結算日收盤價為 31500 點，損益=-10000元，則該筆資料記錄如下：
   | 2023-01 | 賣權避險單 | 2023-01-02 | 28500 | 27600 | 200 | 10000 | 31500 | -10000 |
  
  2.每月的每一部位損益，於 excel 頁面2 以每一部位的損益呈現長條狀。
